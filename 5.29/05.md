# åŒæ­¥
- åœ¨å…±äº«å†…å­˜æœºå™¨ä¸­ï¼Œå…¨å±€æ•°æ®ç”±å¤šä¸ªçº¿ç¨‹å…±äº«
- å¿…é¡»ä½¿ç”¨åŒæ­¥æ¥
- - ä¿æŠ¤å¯¹å…±äº«æ•°æ®çš„è®¿é—®ï¼Œä»Žè€Œé˜²æ­¢ç«žäº‰æƒ…å†µ
- - æ–½åŠ é¡ºåºçº¦æŸ
- OpenMPæ”¯æŒçš„åŒæ­¥ç»“æž„
- - æ‰¹åˆ¤çš„ï¼ŒåŽŸå­å’Œéšœç¢
- - å®Œæ•´çš„OpenMPè§„èŒƒè¿˜æœ‰æ›´å¤š
# åŒæ­¥æž„é€ 
## OpenMP critical æŒ‡ä»¤
- /#pragma omp critical
- - **äº’æ–¥æ‰§è¡Œ**ï¼š åŒä¸€æ—¶åˆ»åªæœ‰ä¸€ä¸ªçº¿ç¨‹å¯ä»¥æ‰§è¡Œä¸´ç•ŒåŒºå†…çš„ä»£ç ã€‚å½“ä¸€ä¸ªçº¿ç¨‹è¿›å…¥ä¸´ç•ŒåŒºæ—¶ï¼Œå…¶ä»–çº¿ç¨‹å¿…é¡»ç­‰å¾…ï¼Œç›´åˆ°è¯¥çº¿ç¨‹é€€å‡ºä¸´ç•ŒåŒºã€‚
- - **ä½œç”¨åŸŸé™åˆ¶**ï¼šcritical æŒ‡ä»¤å¿…é¡»å‡ºçŽ°åœ¨å¹¶è¡ŒåŒºåŸŸï¼ˆ#pragma omp parallelï¼‰å†…éƒ¨ï¼Œå¦åˆ™ä¼šå¯¼è‡´ç¼–è¯‘é”™è¯¯ã€‚
- - **æ€§èƒ½å½±å“**ï¼šè¿‡åº¦ä½¿ç”¨ä¸´ç•ŒåŒºä¼šå¯¼è‡´çº¿ç¨‹é—´é¢‘ç¹ç­‰å¾…ï¼Œé™ä½Žå¹¶è¡Œæ•ˆçŽ‡ã€‚å› æ­¤ï¼Œåº”å°½é‡å‡å°‘ä¸´ç•ŒåŒºçš„ä»£ç é‡ã€‚
- ä¾‹å¦‚ï¼Œçº¿ç¨‹å¢žåŠ è®¡æ•°
- /#pragma omp parallel shared(count)
- {
- ...
- /#pragma omp citical
- count++;
- ...
- }
## OpenMP atomic æŒ‡ä»¤
- /#pragma omp atomic
- - ä¹Ÿæä¾›äº’æ–¥åŠŸèƒ½ï¼Œä½†ä»…é€‚â½¤äºŽâ¼€ä¸ªå†…å­˜ä½ç½®çš„æ›´æ–°
- - atmoicæŒ‡ä»¤ä»…é€‚ç”¨äºŽç´§éšå…¶åŽçš„è¯­å¥
- ä¾‹å¦‚ï¼šç´¯ç§¯å¤šä¸ªçº¿ç¨‹å®Œæˆçš„éƒ¨åˆ†ç»“æžœ 
- double sum = 0.0;
- #pragma omp parallel shared(sum)
{
 double lsum;
 â‹¯
 #pragma omp atomic
 sum += lsum
 â‹¯
}
## OpenMP barrier æŒ‡ä»¤
- #pragma omp barrier
- - barrieræ˜¯ç¨‹åºä¸­æ‰€æœ‰çº¿ç¨‹åœ¨è¢«å…è®¸ç»§ç»­æ‰§â¾ä¹‹å‰å¿…é¡»åˆ°è¾¾çš„ç‚¹
- åœ¨ OpenMP ä¸­ï¼Œâ¼¤å¤šæ•°æž„é€ åœ¨æž„é€ æœ«å°¾éƒ½æœ‰â¼€ä¸ªéšå«çš„å±éšœ
- - è¦æ¶ˆé™¤è¿™ä¸ªéšœç¢ï¼Œä½¿ç”¨nowaitå­å¥ã€‚
- #pragma omp parallel shared(sum)
{
 //all threads do something
 #pragma omp barrier //Threads wait until all threads hit the barrier
 //all threads do some other thing
}
# æŒ‡ä»¤çº§æ•°æ®ä¾èµ–
## ä¸‰ä¸ªç§ç±»
### 1.Â æµä¾èµ–ï¼ˆFlow dependencyï¼ŒRead After Writeï¼ŒRAWï¼‰
- å®šä¹‰ï¼šæŒ‡ä¸€æ¡æŒ‡ä»¤éœ€è¦è¯»å–å¦ä¸€æ¡æŒ‡ä»¤å†™å…¥çš„æ•°æ®ï¼Œå³å†™åŽè¯» ã€‚
- ç¤ºä¾‹ï¼šå…ˆæ‰§è¡ŒÂ a = b + cÂ  ï¼Œå°†Â b + cÂ çš„ç»“æžœå†™å…¥Â aÂ ï¼›åŽç»­Â d = a * eÂ éœ€è¦è¯»å–Â aÂ çš„å€¼æ¥è®¡ç®—å¹¶èµ‹å€¼ç»™Â dÂ ã€‚å¦‚æžœè¿™ä¸¤æ¡æŒ‡ä»¤ä¹±åºæ‰§è¡Œï¼ŒÂ dÂ å°±ä¼šè¯»å–åˆ°é”™è¯¯çš„Â aÂ å€¼ã€‚
### 2.Â åä¾èµ–ï¼ˆAnti - dependencyï¼ŒWrite After Readï¼ŒWARï¼‰
- å®šä¹‰ï¼šä¸€æ¡æŒ‡ä»¤å†™å…¥çš„ç›®çš„å¯„å­˜å™¨æ˜¯å¦ä¸€æ¡æŒ‡ä»¤è¦è¯»å–çš„æºå¯„å­˜å™¨ï¼Œå³è¯»åŽå†™ ã€‚
- ç¤ºä¾‹ï¼šå…ˆæ‰§è¡ŒÂ b = a + cÂ  ï¼Œè¯»å–Â aÂ çš„å€¼æ¥è®¡ç®—å¹¶èµ‹å€¼ç»™Â bÂ ï¼›ç„¶åŽæ‰§è¡ŒÂ a = d * eÂ  ï¼Œå‘Â aÂ å†™å…¥æ–°å€¼ã€‚è‹¥é¡ºåºé”™è¯¯ï¼ŒÂ bÂ è¯»å–çš„Â aÂ å€¼å°±ä¸æ­£ç¡®ã€‚
### 3.Â è¾“å‡ºä¾èµ–ï¼ˆOutput dependencyï¼ŒWrite After Writeï¼ŒWAWï¼‰
- å®šä¹‰ï¼šä¸¤æ¡æŒ‡ä»¤å¯¹åŒä¸€å¯„å­˜å™¨è¿›è¡Œå†™å…¥æ“ä½œï¼Œå³å†™åŽå†™ ã€‚
- ç¤ºä¾‹ï¼šå…ˆæ‰§è¡ŒÂ a = b + cÂ  ï¼Œå†æ‰§è¡ŒÂ a = d * eÂ  ã€‚å¦‚æžœé¡ºåºä¸å½“ï¼Œå¯èƒ½å¯¼è‡´æœ€ç»ˆÂ aÂ çš„å€¼ä¸æ˜¯æœŸæœ›çš„ç»“æžœã€‚
##  æŒ‡ä»¤çº§æ•°æ®ä¾èµ–æ€§â€”â€”æŒ‡ä»¤åºåˆ—ä¸­çš„ä¾èµ–æ€§
- æµä¾èµ–æ˜¯çœŸæ­£çš„ä¾èµ–
- åä¾èµ–å’Œè¾“å‡ºä¾èµ–ä¸æ˜¯çœŸæ­£çš„ï¼ˆæ‰€è°“çš„â¼ˆä¸ºï¼‰ä¾èµ–ï¼Œå¯ä»¥æ¶ˆé™¤
# å¾ªçŽ¯æºå¸¦æ•°æ®ä¾èµ–
> ä¾‹1
for(i=0; i<n; i++)
{
tmp = a[i];
a[i] = b[i];
b[i] = tmp;
}

- ä¸‰æ¡æŒ‡ä»¤å­˜åœ¨æ•°æ®ä¾èµ–å…³ç³»
- ç„¶â½½ï¼Œæ²¡æœ‰æ•°æ®ä¾èµ–å…³ç³»å¯ä»¥æ‰§â¾åˆ°ä¸‹â¼€æ¬¡è¿­ä»£
- å› æ­¤ï¼Œå¾ªçŽ¯å¯ä»¥å®‰å…¨åœ°å¹¶â¾åŒ–
> ä¾‹2
forï¼ˆi=0;i<n;i++ï¼‰
{
    a[i]=b[i]+e[i];
    d[i]=e*a[i+1];
}

> çº¿ç¨‹0ï¼š
a[0] = d[0]+e[0]
d[0] = e * a[1]
a[1] = d[1]+e[1]
d[1] = e * a[2]

>çº¿ç¨‹1:
a[2] = d[2]+e[2]
d[2] = 3 * a[3]
a[3] = d[3]+e[3]
d[3] = e * a[4]

> çº¿ç¨‹2ï¼š
a[4] = d[0]+e[0]
d[0] = e * a[5]
a[5] = d[1]+e[1]
d[1] = e * a[6]
- ç¡®å®žå­˜åœ¨å¾ªçŽ¯æºå¸¦çš„æ•°æ®ä¾èµ–å…³ç³»
- è¿˜æœ‰æ½œåœ¨çš„æ•°æ®ç«žäº‰
- - â¼€ä¸ªçº¿ç¨‹å†™â¼Šï¼Œå¦â¼€ä¸ªçº¿ç¨‹è¯»å–åŒâ¼€æ•°æ®
## è°ƒæ•´æŒ‡ä»¤é¡ºåº
- æ¶ˆé™¤æ•°æ®ä¾èµ–é™åˆ¶ï¼šåœ¨åŒä¸€è¿­ä»£ä¸­ï¼Œè‹¥ä¸¤æ¡æŒ‡ä»¤ä¸å­˜åœ¨æ•°æ®ä¾èµ–ï¼Œè°ƒæ•´é¡ºåºä¸ä¼šå½±å“ç»“æžœã€‚åƒå›¾ä¸­ç¤ºä¾‹ï¼Œè°ƒæ•´åŽå¯ä½¿æŒ‡ä»¤æ‰§è¡Œé¡ºåºæ›´ç¬¦åˆå¤„ç†å™¨æ‰§è¡Œç‰¹æ€§æˆ–ä¼˜åŒ–ç­–ç•¥ï¼Œä¸ºåŽç»­ä¼˜åŒ–ï¼ˆå¦‚å¹¶è¡Œæ‰§è¡Œç›¸å…³ä¼˜åŒ– ï¼‰åˆ›é€ æ¡ä»¶ã€‚
> for (i=0; i<n; i++)
 {
 d[i] = e * a[i+1];
 a[i] = b[i] +e[i];
 }
## æ‹†åˆ†å¾ªçŽ¯
- é™ä½Žæ•°æ®ä¾èµ–å¤æ‚åº¦ï¼šå°†å­˜åœ¨å¤æ‚æ•°æ®ä¾èµ–çš„å¾ªçŽ¯æ‹†åˆ†å¼€ï¼Œå¯ä½¿æ¯ä¸ªæ–°å¾ªçŽ¯å†…çš„æ•°æ®ä¾èµ–å…³ç³»æ›´ç®€å•æ¸…æ™°ã€‚æ¯”å¦‚å›¾ä¸­å¾ªçŽ¯ï¼Œæ‹†åˆ†åŽå¯åˆ†åˆ«åˆ†æžå’Œå¤„ç†æ¯ä¸ªå¾ªçŽ¯çš„æ•°æ®ä¾èµ–ï¼Œé¿å…ç›¸äº’å¹²æ‰°ï¼Œä¸ºå¹¶è¡ŒåŒ–æˆ–å…¶ä»–ä¼˜åŒ–æ‰‹æ®µçš„åº”ç”¨å¥ å®šåŸºç¡€
> for (i=0; i<n; i++)
 d[i] = e * a[i+1];
for (i=0; i<n; i++)
 a[i] = b[i] +e[i];

## çŽ°åœ¨é€ä¸ªå¹¶â¾åŒ–ä¸¤ä¸ª for å¾ªçŽ¯
> #pragma omp parallel for
 for (i=0; i<n; i++)
 d[i] = e * a[i+1];
 **æ­¤å¤„éšå«éšœç¢**
 #pragma omp parallel for
 for (i=0; i<n; i++)
 a[i] = b[i] +e[i]

> Thread 0:
d[0] = e * a[1]
d[1] = e * a[2]
a[0] = b[0]+e[0]
a[1] = b[1]+e[1]

> Thread 1:
d[2] = 3 * a[3]
d[3] = e * a[4]
a[2] = b[2]+e[2]
a[3] = b[3]+e[3]

> Thread 3:
d[4] = e * a[5]
d[5] = e * a[6]
a[4] = b[0]+e[0]
a[5] = b[1]+e[1]

## A simple problem
> for (i=0; i<n; i++)
 {
 a[i+1] = b[i] +e[i];
 d[i] = e * a[i];
 }

> #pragma omp parallel for
for(i=0;i<n;i++)
a[i+1]=b[i]+e[i];
 #pragma omp parallel for
for(i=0;i<n;i++)
d[i]=e*a[i];

## æ³¨æ„
- â¼€èˆ¬æ¥è¯´ï¼Œæˆ‘ä»¬éœ€è¦æ³¨æ„ä»¥ä¸‹å¾ªçŽ¯æºå¸¦çš„æ•°æ®ä¾èµ–æ€§ï¼š
- - æ•°ç»„æ•°æ®çš„ç´¢å¼•ä¸ç­‰äºŽå½“å‰å¾ªçŽ¯ç´¢å¼•
- - å˜é‡çš„å€¼éšç€è¿­ä»£â½½å˜åŒ–
**ä¾‹å­**
>int i, j, A[MAX];
 j = 5;
for (i=0;i< MAX; i++){
 j +=2;
 A[i] = big(j);
 }

 è¿™é‡Œå­˜åœ¨å¾ªçŽ¯æºå¸¦æ•°æ®ä¾èµ–ã€‚æ¯æ¬¡å¾ªçŽ¯ä¸­ Â jÂ  çš„å€¼éƒ½ä¾èµ–äºŽä¸Šä¸€æ¬¡å¾ªçŽ¯ Â jÂ  çš„å€¼ï¼ˆÂ j += 2Â  ï¼‰ã€‚è¿™æ„å‘³ç€å¾ªçŽ¯è¿­ä»£ä¸èƒ½éšæ„å¹¶è¡Œæ‰§è¡Œï¼Œå› ä¸ºå¦‚æžœå¹¶è¡Œï¼ŒÂ jÂ  çš„æ›´æ–°é¡ºåºå°±ä¼šæ··ä¹±ï¼Œå¯¼è‡´è®¡ç®—ç»“æžœé”™è¯¯ã€‚
>  int i, A[MAX];
 #pragma omp parallel for
for (i=0;i< MAX; i++) {
 int j = 5 + 2*(i+1);
 A[i] = big(j);
 }

é€šè¿‡å°† Â jÂ  çš„è®¡ç®—æ–¹å¼ä¿®æ”¹ä¸ºä»…ä¾èµ–äºŽå¾ªçŽ¯ç´¢å¼• Â iÂ  ï¼Œæ¶ˆé™¤äº†å¾ªçŽ¯æºå¸¦æ•°æ®ä¾èµ–ã€‚Â #pragma omp parallel forÂ  æ˜¯OpenMPæŒ‡ä»¤ï¼Œç”¨äºŽæŒ‡ç¤ºç¼–è¯‘å™¨å°† Â forÂ  å¾ªçŽ¯å¹¶è¡ŒåŒ–ã€‚è¿™é‡Œ Â jÂ  çš„å€¼åœ¨æ¯æ¬¡è¿­ä»£ä¸­éƒ½å¯ä»¥ç‹¬ç«‹è®¡ç®—ï¼Œä¸ä¾èµ–äºŽå‰ä¸€æ¬¡è¿­ä»£çš„ç»“æžœï¼Œæ‰€ä»¥å¯ä»¥å®‰å…¨åœ°è¿›è¡Œå¹¶è¡Œè®¡ç®—
# è§„çº¦è®¡ç®—
## ç»™å®šç»“åˆè¿ç®—ç¬¦âŠ•
- ç¤ºä¾‹
- - æ·»åŠ  (+)
- - ä¹˜æ³• (*)
- - å’Œã€æˆ–ï¼ˆ&&ã€||ï¼‰
- - maxï¼Œmin
- ä»¥åŠå…ƒç´ æ•°ç»„ [ð‘Ž0, ð‘Ž1, ð‘Ž2, â€¦, ð‘Žð‘›âˆ’1] 
- è®¡ç®—
- S = ð‘Ž0 âŠ• ð‘Ž1 âŠ• ð‘Ž2 âŠ• â€¦ âŠ• ð‘Žð‘›âˆ’1
## æ±‚å’Œç¤ºä¾‹
![alt text](image.png)
**ç„¶è€Œ**
1. åŠ æ³•æ˜¯ç»“åˆå¾‹å’Œäº¤æ¢å¾‹
æˆ‘ä»¬å¯ä»¥æŒ‰ä»»æ„é¡ºåºæ·»åŠ æ•°å­—
ä¾‹å¦‚ï¼š
![alt text](image-1.png)
2. åˆ©ç”¨OpenMPæŒ‡ä»¤å¯ä»¥å°†å¾ªçŽ¯å¹¶è¡ŒåŒ–ã€‚è®©æ¯ä¸ªçº¿ç¨‹åˆ†åˆ«è®¡ç®—ä¸€éƒ¨åˆ†å’Œï¼ˆpartial sumï¼Œå³ä¸Šè¿°çš„S_0ã€S_1ã€S_2 ç­‰ï¼‰ï¼Œç„¶åŽå†å°†è¿™äº›éƒ¨åˆ†å’Œç´¯åŠ èµ·æ¥å¾—åˆ°æœ€ç»ˆç»“æžœã€‚è¿™æ ·åˆ©ç”¨å¤šçº¿ç¨‹å¹¶è¡Œè®¡ç®—ï¼Œèƒ½æé«˜è®¡ç®—æ•ˆçŽ‡ï¼Œå°¤å…¶å½“æ•°æ®é‡nå¾ˆå¤§æ—¶ï¼Œç›¸æ¯”ä¸²è¡Œè®¡ç®—èƒ½å¤§å¹…å‡å°‘è®¡ç®—æ—¶é—´ã€‚ ä¾‹å¦‚åœ¨å¤šæ ¸CPUä¸Šï¼Œä¸åŒæ ¸å¿ƒçš„çº¿ç¨‹å¯ä»¥åŒæ—¶è®¡ç®—ä¸åŒç»„çš„å’Œï¼Œæœ€åŽå†æ±‡æ€»ã€‚
3. ä»£ç 
>#pragma omp parallel shared(a,S) private(i)
 {
 double lsum = 0.0; //each thread has a local lsum variable
 #pragma omp for nowait
 for (i=0; i<n; i++) //the number of iterations distributed
 lsum += a[i]; //each thread calculate a partial sum
 â‹¯ //accumulate partial sums
 }

4. æ€Žæ ·åŽ»ç´¯ç§¯éƒ¨åˆ†å’Œ
- 1.ä¸´ç•ŒåŒº
- å¯ä»¥ä½¿ç”¨ Â #pragma omp criticalÂ  æŒ‡ä»¤ã€‚åœ¨æ‰€æœ‰çº¿ç¨‹è®¡ç®—å®Œéƒ¨åˆ†å’ŒåŽï¼Œé€šè¿‡ä¸´ç•ŒåŒºæ¥ä¿è¯åŒä¸€æ—¶åˆ»åªæœ‰ä¸€ä¸ªçº¿ç¨‹èƒ½æ‰§è¡Œç´¯åŠ æ“ä½œã€‚ç¤ºä¾‹ä»£ç å¦‚ä¸‹
- > #pragma omp parallel shared(a,S) private(i)
{
    double lsum = 0.0;
    #pragma omp for nowait
    for (i = 0; i < n; i++)
        lsum += a[i];
    #pragma omp critical
    {
        S += lsum; // å°†å±€éƒ¨éƒ¨åˆ†å’Œç´¯åŠ åˆ°å…±äº«å˜é‡Sä¸­
    }
}
# OpenMPè§„çº¦å­å¥
1. Â è¯­æ³•
Â reduction (op : list)Â  ï¼šè¿™æ˜¯OpenMPå½’çº¦å­å¥çš„è¯­æ³•å½¢å¼ã€‚å…¶ä¸­ Â opÂ  è¡¨ç¤ºå½’çº¦æ“ä½œç¬¦ï¼Œå¦‚ Â +Â ï¼ˆåŠ æ³•ï¼‰ã€Â *Â ï¼ˆä¹˜æ³•ï¼‰ç­‰ ï¼›Â listÂ  æ˜¯å‚ä¸Žå½’çº¦æ“ä½œçš„å˜é‡åˆ—è¡¨ã€‚
2. Â ç¤ºä¾‹ä»£ç è§£æž
- Â double S = 0;Â  ï¼šå£°æ˜Žä¸€ä¸ªåŒç²¾åº¦ç±»åž‹çš„å˜é‡ Â SÂ  å¹¶åˆå§‹åŒ–ä¸º0ï¼Œç”¨äºŽå­˜å‚¨æœ€ç»ˆçš„æ±‚å’Œç»“æžœã€‚
- Â #pragma omp parallel for shared(S, a), reduction(+:S)Â  ï¼šè¿™æ˜¯OpenMPæŒ‡ä»¤ã€‚Â #pragma omp parallel forÂ  è¡¨ç¤ºå°†ç´§éšå…¶åŽçš„ Â forÂ  å¾ªçŽ¯å¹¶è¡ŒåŒ–ï¼›Â shared(S, a)Â  è¡¨ç¤ºå˜é‡ Â SÂ  å’Œæ•°ç»„ Â aÂ  åœ¨å¹¶è¡ŒåŒºåŸŸå†…æ˜¯å…±äº«çš„ï¼›Â reduction(+:S)Â  è¡¨ç¤ºå¯¹å˜é‡ Â SÂ  è¿›è¡ŒåŠ æ³•å½’çº¦æ“ä½œã€‚
- Â for (int i = 0; i < n; ++i) S += a[i];Â  ï¼šå¹¶è¡ŒåŒ–çš„ Â forÂ  å¾ªçŽ¯ï¼Œåœ¨æ¯æ¬¡è¿­ä»£ä¸­ï¼Œå°†æ•°ç»„ Â aÂ  çš„å…ƒç´ ç´¯åŠ åˆ°å˜é‡ Â SÂ  ä¸Šã€‚
3. Â å½’çº¦å­å¥å·¥ä½œåŽŸç†
- å±€éƒ¨å˜é‡åˆ›å»ºä¸Žåˆå§‹åŒ–ï¼šå½“ä½¿ç”¨å½’çº¦å­å¥æ—¶ï¼ŒOpenMPä¼šä¸ºæ¯ä¸ªçº¿ç¨‹åˆ›å»ºä¸€ä¸ªå±€éƒ¨çš„ Â SÂ  å‰¯æœ¬ï¼Œå¹¶æ ¹æ®å½’çº¦æ“ä½œç¬¦è¿›è¡Œåˆå§‹åŒ–ã€‚å¯¹äºŽåŠ æ³•æ“ä½œç¬¦ Â +Â  ï¼Œåˆå§‹å€¼ä¸º0ã€‚ä¾‹å¦‚ï¼Œå‡è®¾æœ‰4ä¸ªçº¿ç¨‹ï¼Œæ¯ä¸ªçº¿ç¨‹éƒ½ä¼šæœ‰è‡ªå·±ç‹¬ç«‹çš„ Â SÂ  å‰¯æœ¬ï¼Œä¸”éƒ½åˆå§‹åŒ–ä¸º0ã€‚
- å±€éƒ¨æ›´æ–°ï¼šåœ¨å¹¶è¡Œå¾ªçŽ¯æ‰§è¡Œè¿‡ç¨‹ä¸­ï¼Œæ¯ä¸ªçº¿ç¨‹å¯¹è‡ªå·±çš„å±€éƒ¨ Â SÂ  å‰¯æœ¬è¿›è¡Œæ›´æ–°ã€‚æ¯”å¦‚åœ¨ä¸Šè¿°æ±‚å’Œä¾‹å­ä¸­ï¼Œæ¯ä¸ªçº¿ç¨‹åœ¨è‡ªå·±è´Ÿè´£çš„å¾ªçŽ¯è¿­ä»£é‡Œï¼Œå°†æ•°ç»„ Â aÂ  çš„å¯¹åº”å…ƒç´ ç´¯åŠ åˆ°è‡ªå·±çš„å±€éƒ¨ Â SÂ  ä¸Šã€‚
- æœ€ç»ˆå½’çº¦ï¼šå¾ªçŽ¯ç»“æŸåŽï¼Œå„ä¸ªçº¿ç¨‹çš„å±€éƒ¨ Â SÂ  å‰¯æœ¬ä¼šè¢«å½’çº¦æˆä¸€ä¸ªæœ€ç»ˆå€¼ã€‚OpenMPä¼šè‡ªåŠ¨å¤„ç†è¿™ä¸ªåˆå¹¶è¿‡ç¨‹ï¼Œå°†æ‰€æœ‰å±€éƒ¨ç»“æžœåˆå¹¶èµ·æ¥å¾—åˆ°æœ€ç»ˆçš„å…¨å±€ç»“æžœï¼Œå­˜å‚¨åœ¨åŽŸå§‹çš„å…±äº«å˜é‡ Â SÂ  ä¸­ã€‚
- å˜é‡å…±äº«è¦æ±‚ï¼šå½’çº¦å­å¥ä¸­ Â listÂ  é‡Œçš„å˜é‡ï¼ˆè¿™é‡Œæ˜¯ Â SÂ  ï¼‰å¿…é¡»åœ¨åŒ…å«å®ƒçš„å¹¶è¡ŒåŒºåŸŸå†…æ˜¯å…±äº«å˜é‡ã€‚è¿™æ˜¯å› ä¸ºæœ€ç»ˆç»“æžœéœ€è¦åœ¨æ‰€æœ‰çº¿ç¨‹é—´è¿›è¡Œæ±‡æ€»å’Œå…±äº«ã€‚
4. å¯ä»¥ä½¿â½¤è®¸å¤šä¸åŒçš„å…³è”æ“ä½œæ•°
åˆå§‹å€¼æ˜¯æ•°å­¦ä¸Šæœ‰æ„ä¹‰çš„å€¼
![alt text](image-2.png)
## Lab
![alt text](image-3.png)
![alt text](image-4.png)
# æ‰«ææ“ä½œ
 æ‰«ææ“ä½œï¼ˆScan Operationï¼‰è®²è§£
 
1.Â å®šä¹‰
æ‰«ææ“ä½œï¼ˆä¹Ÿç§°ä¸ºå‰ç¼€æ“ä½œï¼‰ä½œç”¨äºŽä¸€ä¸ªæ•°ç»„A = [a_0, a_1, a_2, ... a_{n - 1}] ï¼Œå…¶ä¸­âŠ•æ˜¯ä¸€ä¸ªæ»¡è¶³ç»“åˆå¾‹çš„æ“ä½œç¬¦ï¼ˆå¦‚åŠ æ³•ã€ä¹˜æ³•ç­‰ ï¼‰ã€‚å®ƒç”Ÿæˆä¸€ä¸ªæ–°æ•°ç»„C ï¼ŒC çš„å…ƒç´ è®¡ç®—æ–¹å¼ä¸ºï¼šC = [a_0, (a_0âŠ•a_1), (a_0 âŠ• a_1 âŠ• a_2), ... (a_0âŠ•a_1 âŠ• a_2 âŠ•... âŠ• a_{n - 1})] ã€‚
2.Â ç¤ºä¾‹
å½“æ•°ç»„A = [1, 2, 3, 4, 5, 6] ï¼Œä½¿ç”¨åŠ æ³•ä½œä¸ºâŠ•æ“ä½œç¬¦æ—¶ï¼Œæ‰«ææ“ä½œåŽå¾—åˆ°C = [1, 3, 6, 10, 15, 21] ã€‚å…·ä½“è®¡ç®—è¿‡ç¨‹ä¸ºï¼š
- (C[0]=1]=) ï¼›
- (C[1]=1 + 2 = 3]=) ï¼›
- (C[2]=1 + 2 + 3 = 6]=) ï¼›
- (C[3]=1 + 2 + 3 + 4 = 10]=) ï¼›
- (C[4]=1 + 2 + 3 + 4 + 5 = 15]=) ï¼›
- (C[5]=1 + 2 + 3 + 4 + 5 + 6 = 21]=) ã€‚
3.Â å‡å°‘å†—ä½™è®¡ç®—
åœ¨è®¡ç®—]=(C]=) æ•°ç»„å…ƒç´ æ—¶ï¼Œå­˜åœ¨å¾ˆå¤šå†—ä½™è®¡ç®—ã€‚ä¾‹å¦‚è®¡ç®—]=(C[3]) æ—¶ï¼Œ]=(1 + 2 + 3 + 4]=) ä¸­]=(1 + 2 + 3]=) çš„è®¡ç®—åœ¨è®¡ç®—]=(C[2]) æ—¶å·²ç»åšè¿‡äº†ã€‚å¯ä»¥ä½¿ç”¨é€’å½’ç­‰æ–¹æ³•æ¥æ¶ˆé™¤è¿™äº›å†—ä½™æ“ä½œ ã€‚
4.Â é¡ºåºè®¡ç®—ä»£ç åŠæ“ä½œæ¬¡æ•°
 
- ä»£ç ï¼š
 
c[0] = a[0];
for (i = 1; i < n; i++)
    c[i] = c[i - 1] âŠ• a[i];
Â 
 
è¿™é‡Œå…ˆå°†C æ•°ç»„çš„ç¬¬ä¸€ä¸ªå…ƒç´ èµ‹å€¼ä¸ºA æ•°ç»„çš„ç¬¬ä¸€ä¸ªå…ƒç´ ï¼Œç„¶åŽé€šè¿‡å¾ªçŽ¯ï¼Œåˆ©ç”¨å‰ä¸€ä¸ªå·²è®¡ç®—å‡ºçš„C æ•°ç»„å…ƒç´ å’Œå½“å‰A æ•°ç»„å…ƒç´ ï¼Œè®¡ç®—å½“å‰C æ•°ç»„å…ƒç´ ã€‚
 
- æ“ä½œæ¬¡æ•°ï¼šæ€»å…±åªéœ€è¦n - 1 æ¬¡âŠ•æ“ä½œã€‚å› ä¸ºä»Žç¬¬äºŒä¸ªå…ƒç´ å¼€å§‹è®¡ç®—ï¼Œä¸€å…±n - 1 ä¸ªå…ƒç´ éœ€è¦é€šè¿‡âŠ•æ“ä½œæ¥è®¡ç®—ã€‚
# æ‰«ææ“ä½œçš„å¹¶è¡Œç®—æ³•
- é¡ºåºä¾‹ç¨‹â¾®å¸¸ç®€å•ï¼Œä½†æœ¬è´¨ä¸Šæ˜¯ä¸¥æ ¼é¡ºåºçš„
- éœ€è¦è®¾è®¡æ–°çš„å¹¶â¾ç®—æ³•
- è®¸å¤šâ½¤äºŽæ‰«ææ“ä½œçš„å¹¶â¾ç®—æ³•å·²ç»åŸºäºŽä»¥ä¸‹äº‹å®žâ½½å¼€å‘å‡ºæ¥ï¼š
- - âŠ•æ˜¯ç»“åˆè¿ç®—ç¬¦
- å…³é”®æ˜¯å°½é‡å‡å°‘æ“ä½œé‡
![alt text](image-5.png)
![alt text](image-6.png)
![alt text](image-7.png)
![alt text](image-8.png)
 ![alt text](adbc626b4c163dba8947d86d3ad83876-1.jpg)

## æ‰«ææ“ä½œå¹¶è¡Œç®—æ³•æ­¥éª¤

å¹¶è¡Œç®—æ³•æ­¥éª¤
 
- é˜¶æ®µ1ï¼šæ¯ä¸ªçº¿ç¨‹èŽ·å– n/t ä¸ªå…ƒç´ çš„å­é›†ï¼ˆå—åˆ’åˆ†ï¼‰ ï¼Œå¯¹åˆ†é…åˆ°çš„å…ƒç´ æ‰§è¡Œæœ¬åœ°æ‰«ææ“ä½œã€‚é™¤äº†æœ€åŽä¸€ä¸ªçº¿ç¨‹å¤–ï¼Œçº¿ç¨‹ i å°†å…¶æœ€åŽä¸€ä¸ªæœ¬åœ° c å…ƒç´ å­˜å‚¨åˆ°å·¥ä½œæ•°ç»„ w[i + 1] ä¸­ã€‚ä¾‹å¦‚å°†å…ƒç´ åˆ†ç»„ä¸º [a_0,a_1,a_2]ã€[a_3,a_4,a_5] ç­‰å½¢å¼è¿›è¡Œæœ¬åœ°æ‰«æè®¡ç®— ï¼Œå¹¶æ¶‰åŠåˆ°å¦‚ c_0 = a_0ï¼Œc_{0 - 1}=c_0âŠ• a_1 ç­‰è®¡ç®—ï¼ˆâŠ• ä»£è¡¨æŸç§è¿ç®—ï¼‰ã€‚å¹¶ä¸”åœ¨é˜¶æ®µä¹‹é—´å¿…é¡»è¿›è¡ŒåŒæ­¥ï¼ˆéšå¼æˆ–æ˜¾å¼ï¼‰ã€‚
- é˜¶æ®µ2ï¼šå•ä¸ªçº¿ç¨‹å¯¹å·¥ä½œæ•°ç»„ W æ‰§è¡Œæ‰«ææ“ä½œ ã€‚
- é˜¶æ®µ3ï¼šæ¯ä¸ªçº¿ç¨‹å°† w[i] ä¸Žæ¯ä¸ªéƒ¨åˆ†æ‰«æå…ƒç´ è¿›è¡Œ âŠ•è¿ç®— ã€‚
 
ç®—æ³•ç‰¹ç‚¹
 
- è¯¥å¹¶è¡Œç®—æ³•ç”±ä¸‰ä¸ªå¹¶è¡Œé˜¶æ®µç»„æˆï¼Œé˜¶æ®µä¹‹é—´éœ€è¦åŒæ­¥ ã€‚åœ¨ç¬¬äºŒé˜¶æ®µåªæœ‰ä¸€ä¸ªçº¿ç¨‹å¤„äºŽæ´»åŠ¨çŠ¶æ€ï¼Œè™½ç„¶æ˜¯çº¯é¡ºåºæ‰§è¡Œï¼Œä½†ç”±äºŽSMæœºå™¨é€šå¸¸è§„æ¨¡è¾ƒå°ï¼Œå¼€é”€å¹¶ä¸é«˜ ã€‚
 
æ“ä½œæ•°é‡åˆ†æž
 
- é˜¶æ®µ1ï¼šæ¯ä¸ªçº¿ç¨‹å¯¹ n/t ä¸ªå…ƒç´ æ‰§è¡Œæœ¬åœ°æ‰«æï¼Œæ“ä½œæ•°é‡ä¸º (n/t - 1)*t=n - t ã€‚
- é˜¶æ®µ2ï¼šå•ä¸ªçº¿ç¨‹å¯¹ Wï¼ˆå¤§å°ä¸º t ï¼‰æ‰§è¡Œæ‰«æï¼Œæ“ä½œæ•°é‡ä¸º t - 1 ã€‚
- é˜¶æ®µ3ï¼šæ¯ä¸ªçº¿ç¨‹å°† w_i æ·»åŠ åˆ°éƒ¨åˆ†æ‰«æå…ƒç´ ï¼Œæ“ä½œæ•°é‡ä¸º n/t*t = n ã€‚
- æ€»æ“ä½œæ•°é‡ä¸º n - t + t - 1 + n=2n - 1 ï¼Œè€Œé¡ºåºè®¡ç®—çš„æ€»æ“ä½œæ•°é‡æ˜¯ n - 1 ï¼Œå¹¶è¡Œç®—æ³•ä½¿æ“ä½œæ•°é‡å¢žåŠ äº†ä¸€å€ ã€‚ä½†å¹¶è¡Œæ—¶é—´ä¸º 2n/t + t + é€šä¿¡ä¸ŽåŒæ­¥æ—¶é—´ï¼Œå½“çº¿ç¨‹æ•°é‡å¤§äºŽ2æ—¶ï¼Œå®Œæˆè®¡ç®—æ‰€éœ€æ—¶é—´æ›´å°‘ã€‚
 
è¿™ç§å¹¶è¡Œæ‰«æç®—æ³•å¸¸ç”¨äºŽé«˜æ€§èƒ½è®¡ç®—ã€å¹¶è¡Œè®¡ç®—æž¶æž„ï¼ˆå¦‚GPUè®¡ç®—ï¼‰ç­‰åœºæ™¯ä¸­ï¼Œé€šè¿‡å¤šçº¿ç¨‹å¹¶è¡Œå¤„ç†æé«˜è®¡ç®—æ•ˆçŽ‡ï¼Œå‡å°‘å¤§è§„æ¨¡æ•°æ®æ‰«ææ“ä½œçš„æ•´ä½“æ‰§è¡Œæ—¶é—´ ã€‚
# homework
![alt text](image-9.png)